---
type: docs
title: "操作方法：在 Dapr 中启用 actor 的可重入性"
linkTitle: "How-To: Actor reentrancy"
weight: 30
description: 了解更多关于 actor 可重入性
---

## Actor可重入性
A core tenet of the virtual actor pattern is the single-threaded nature of actor execution. 在不重入的情况下，Dapr 运行时会锁定所有Actor 组件请求，甚至包括位于同一调用链中的请求。 A second request could not start until the first had completed. 这意味着一个actor不能调用自己，或者让另一个actor调用它，即使它是同一链的一部分。 可重入性通过允许来自同一链或同一上下文的请求重新进入已锁定的 actor 来解决这个问题。 这在以下情况下特别有用：Actor 想要调用自身上的方法，或者在工作流中使用Actor，其中其他Actors 用于执行工作，然后他们回调协调参与者。 可重入性的调用链示例如下：

```
Actor A -> Actor A
ActorA -> Actor B -> Actor A
```

With reentrancy, there can be more complex actor calls without sacrificing the single-threaded behavior of virtual actors.

<img src="/images/actor-reentrancy.png" width=1000 height=500 alt="显示调用工作角色的协调工作流 actor 或在其自身上调用方法的actor 的重入关系的图示">

`maxStackDepth` 参数设置一个值，该值控制对同一参与者进行多少次可重入调用。 默认情况下，此值设置为 32，这在大多数情况下已足够。

## 使用 Actor 配置启用 Actor 可重入性

将重入的Actor 必须提供配置才能使用重入。 This is done by the actor's endpoint for `GET /dapr/config`, similar to other actor configuration elements.

{{< tabs Dotnet Python Go >}}

{{% codetab %}}

```csharp
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddSingleton<BankService>();
        services.AddActors(options =>
        {
        options.Actors.RegisterActor<DemoActor>();
        options.ReentrancyConfig = new Dapr.Actors.ActorReentrancyConfig()
            {
            Enabled = true,
            MaxStackDepth = 32,
            };
        });
    }
}
```

{{% /codetab %}}

{{% codetab %}}
```python
from fastapi import FastAPI
from dapr.ext.fastapi import DaprActor
from dapr.actor.runtime.config import ActorRuntimeConfig, ActorReentrancyConfig
from dapr.actor.runtime.runtime import ActorRuntime
from demo_actor import DemoActor

reentrancyConfig = ActorReentrancyConfig(enabled=True)
config = ActorRuntimeConfig(reentrancy=reentrancyConfig)
ActorRuntime.set_actor_config(config)
app = FastAPI(title=f'{DemoActor.__name__}Service')
actor = DaprActor(app)

@app.on_event("startup")
async def startup_event():
    # Register DemoActor
    await actor.register_actor(DemoActor)

@app.get("/MakeExampleReentrantCall")
def do_something_reentrant():
    # invoke another actor here, reentrancy will be handled automatically
    return
```
{{% /codetab %}}

{{% codetab %}}

这是一个用 Golang 编写的 actor 配置代码片段，通过 HTTP API 提供重入配置。 可重入性尚未包含在 Go SDK 中。

```go
type daprConfig struct {
    Entities                []string                `json:"entities,omitempty"`
    ActorIdleTimeout        string                  `json:"actorIdleTimeout,omitempty"`
    ActorScanInterval       string                  `json:"actorScanInterval,omitempty"`
    DrainOngoingCallTimeout string                  `json:"drainOngoingCallTimeout,omitempty"`
    DrainRebalancedActors   bool                    `json:"drainRebalancedActors,omitempty"`
    Reentrancy              config.ReentrancyConfig `json:"reentrancy,omitempty"`
}

var daprConfigResponse = daprConfig{
    []string{defaultActorType},
    actorIdleTimeout,
    actorScanInterval,
    drainOngoingCallTimeout,
    drainRebalancedActors,
    config.ReentrancyConfig{Enabled: true, MaxStackDepth: &maxStackDepth},
}

func configHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "application/json")
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(daprConfigResponse)
}
```

### Handling reentrant requests
The key to a reentrant request is the `Dapr-Reentrancy-Id` header. The value of this header is used to match requests to their call chain and allow them to bypass the actor's lock.

The header is generated by the Dapr runtime for any actor request that has a reentrant config specified. Once it is generated, it is used to lock the actor and must be passed to all future requests. 以下是处理此问题的 actor 的代码片段：

```go
func reentrantCallHandler(w http.ResponseWriter, r *http.Request) {
    /*
     * Omitted.
     */

    req, _ := http.NewRequest("PUT", url, bytes.NewReader(nextBody))

    reentrancyID := r.Header.Get("Dapr-Reentrancy-Id")
    req.Header.Add("Dapr-Reentrancy-Id", reentrancyID)

    client := http.Client{}
    resp, err := client.Do(req)

    /*
     * Omitted.
     */
}
```

{{% /codetab %}}

{{< /tabs >}}

观看此 [视频](https://www. youtube. com/watch? v=Qadhq5v-gww& list=Plcip_LgkYwzuF-Ov6zKRADoiBvUvGhkao& t=674s) ，了解如何使用Actor 可重入性。
<div class="embed-responsive embed-responsive-16by9">
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/QADHQ5v-gww?start=674" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
