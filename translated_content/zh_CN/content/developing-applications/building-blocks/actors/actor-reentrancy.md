---
type: docs
title: "如何：在Dapr中启用 Actor 的可重入性"
linkTitle: "如何：Actor的可重入性"
weight: 30
description: 了解更多关于 actor 可重入性
---

{{% alert title="Preview feature" color="warning" %}}
Actor可重入性当前处于 [preview]({{< ref preview-features.md >}})状态。
{{% /alert %}}

## Actor可重入性
虚拟 actor 模式的核心原则是 actor 执行的单线程性质。 在 reentrancy 之前，这导致 Dapr runtime 锁定任何给定请求的 actor 。 第二个请求要到第一个请求完成后才能开始。 这种行为意味着 actor 不能调用自己，或让另一个 actor 调用它，即使它是同一链的一部分。 Reentrancy 通过允许来自同一链或上下文的请求重新输入已锁定的参与者来解决这个问题。 Reentrancy 的调用链示例如下：

```
Actor A -> Actor A
ActorA -> Actor B -> Actor A
```

通过 reentrancy，可以在不牺牲虚拟 actor 单线程行为的情况下，有更复杂的 actor 调用。

## 启用 Actor reentrancy
Actor reentrancy 进入当前处于预览阶段，因此启用它是几步过程。

### 预览功能配置
在使用 reentrancy 之前，必须在 Dapr 中启用该功能。 有关预览配置的更多信息，请参阅 [在 Dapr 中的预览特性]({{< ref preview-features.md >}})中的完整指南。 以下是 Actor reentrancy 配置的示例：

```yaml
apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: reentrantconfig
spec:
  features:
    - name: Actor.Reentrancy
      enabled: true
```

### Actor 运行时配置
一旦将 Actor reentrancy 作为选择加入预览功能启用，reentrancy 的 actor 还必须提供适当的配置才能使用 reentrancy。 这是由 `GET /dapr/config`的 actor 终结点完成的，类似于其他 actor 配置元素。 以下是用 Golang 编写的 actor 代码片段，提供配置：

```go
type daprConfig struct {
    Entities                []string                `json:"entities,omitempty"`
    ActorIdleTimeout        string                  `json:"actorIdleTimeout,omitempty"`
    ActorScanInterval       string                  `json:"actorScanInterval,omitempty"`
    DrainOngoingCallTimeout string                  `json:"drainOngoingCallTimeout,omitempty"`
    DrainRebalancedActors   bool                    `json:"drainRebalancedActors,omitempty"`
    Reentrancy              config.ReentrancyConfig `json:"reentrancy,omitempty"`
}

var daprConfigResponse = daprConfig{
    []string{defaultActorType},
    actorIdleTimeout,
    actorScanInterval,
    drainOngoingCallTimeout,
    drainRebalancedActors,
    config.ReentrancyConfig{Enabled: true, MaxStackDepth: &maxStackDepth},
}

func configHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "application/json")
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(daprConfigResponse)
}
```

### 重入请求处理
重入请求的关键是名为`Dapr-Reentrancy-Id`的请求头。 该请求头的值用于匹配请求与他们的执行链，允许他们绕过行为者的锁定。

The header is generated by the Dapr runtime for any actor request that has a reentrant config specified. Once it is generated, it is used to lock the actor and must be passed to all future requests. Below is a snippet of code from an actor handling this is Golang:

```go
func reentrantCallHandler(w http.ResponseWriter, r *http.Request) {
    /*
     * Omitted.
     */

    req, _ := http.NewRequest("PUT", url, bytes.NewReader(nextBody))

    reentrancyID := r.Header.Get("Dapr-Reentrancy-Id")
    req.Header.Add("Dapr-Reentrancy-Id", reentrancyID)

    client := http.Client{}
    resp, err := client.Do(req)

    /*
     * Omitted.
     */
}
```

Currently, no SDK supports actor reentrancy. In the future, the method for handling the reentrancy id may be different based on the SDK that is being used.
