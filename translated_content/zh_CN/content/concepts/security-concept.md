---
type: docs
title: "Security"
linkTitle: "Security"
weight: 600
description: Dapr在设计时是如何考虑安全的
---

安全是 Dapr 的基础。 This article describes the security features and capabilities when using Dapr in a distributed application. 这些可分为：

- Secure communication with service invocation and pub/sub APIs.
- 组件的安全策略，并通过配置应用。
- 操作安全实践。
- 状态安全，专注于静态数据。

一个示例应用程序用于说明 Dapr 中许多可用的安全功能。

# 安全通信

Dapr provides end-to-end security with the service invocation API, with the ability to authenticate an application with Dapr and set endpoint access policies. 如下图所示。

<img src="/images/security-end-to-end-communication.png" width=1000>

## 服务调用范围的访问策略

Dapr applications can be scoped to namespaces for deployment and security. You can call between services deployed to different namespaces. Read the [Service invocation across namespaces]({{< ref "service-invocation-namespaces.md" >}}) article for more details.

Dapr 应用程序可以限制哪些操作可以被调用，包括允许（或拒绝）哪些应用程序可以调用它。 Read [How-To: Apply access control list configuration for service invocation]({{< ref invoke-allowlist.md >}}) for more details.

## Pub/sub topic scoping access policy

For pub/sub components, you can limit which topic types and applications are allowed to publish and subscribe to specific topics. 请阅读 [限定 Pub/Sub topic 访问]({{< ref "pubsub-scopes.md" >}}) 了解更多详细信息。

## 使用 mTLS 加密数据

One of Dapr's security mechanisms for encrypting data in transit is [mutual authentication TLS](https://en.wikipedia.org/wiki/Mutual_authentication) or mTLS. mTLS 为应用程序内的网络流量提供了一些关键功能：

- **Two way authentication**, with the client proving its identity to the server, and vice-versa.
- **An encrypted channel** for all in-flight communication, after two-way authentication is established.

mTLS is useful in almost all scenarios, but especially for systems subject to regulations such as [HIPAA](https://en.wikipedia.org/wiki/Health_Insurance_Portability_and_Accountability_Act) and [PCI](https://en.wikipedia.org/wiki/Payment_Card_Industry_Data_Security_Standard).

## 保护 Dapr 到 Dapr 的通信

Dapr 在您的生产系统中无需额外代码或复杂配置即可启用 mTLS。 Equally, Dapr sidecars prevent all IP addresses by default other than `localhost` from calling it, unless explicitly listed.

Dapr includes an "on by default", automatic mTLS that provides in-transit encryption for traffic between Dapr sidecars. To achieve this, Dapr leverages a system service named `Sentry`, which acts as a Certificate Authority (CA)/Identity Provider and signs workload (app) certificate requests originating from the Dapr sidecar.

By default, a workload certificate is valid for 24 hours and the clock skew is set to 15 minutes.

Unless you've provided existing root certificates, the Sentry service automatically creates and persists self-signed root certificates valid for one year. Dapr manages workload certificate rotation; if you bring your own certificates, Dapr does so with zero downtime to the application.

When root certificates are replaced (secret in Kubernetes mode and filesystem for self-hosted mode), Sentry picks them up and rebuilds the trust chain, without restart and with zero downtime to Sentry.

When a new Dapr sidecar initializes, it checks if mTLS is enabled. If so, an ECDSA private key and certificate signing request are generated and sent to Sentry via a gRPC interface. The communication between the Dapr sidecar and Sentry is authenticated using the trust chain certificate, which is injected into each Dapr instance by the Dapr Sidecar Injector system service.

### 配置 mTLS

mTLS can be turned on/off by editing the default configuration deployed with Dapr via the `spec.mtls.enabled` field.

[You can do this for both Kubernetes and self-hosted modes]({{< ref mtls.md >}}).

#### 自托管模式下的 mTLS

The diagram below shows how the Sentry system service issues certificates for applications based on the root/issuer certificate provided by an operator or generated by the Sentry service as stored in a file.

<img src="/images/security-mTLS-sentry-selfhosted.png" width=1000>

#### kubernetes 模式下的 mTLS

In a Kubernetes cluster, the secret that holds the root certificates is:

- Scoped to the namespace in which the Dapr components are deployed.
- Only accessible by the Dapr control plane system pods.

Dapr also supports strong identities when deployed on Kubernetes, relying on a pod's Service Account token sent as part of the certificate signing request (CSR) to Sentry.

The diagram below shows how the Sentry system service issues certificates for applications based on the root/issuer certificate provided by an operator or generated by the Sentry service and stored as a Kubernetes secret

<img src="/images/security-mTLS-sentry-kubernetes.png" width=1000>

### 在 Dapr 上阻止 IP 地址

To prevent Dapr sidecars from being called on any IP address (especially in production environments such as Kubernetes), Dapr restricts its listening IP addresses only to `localhost`. Use the [dapr-listen-addresses](https://docs.dapr.io/reference/arguments-annotations-overview/) setting you need to enable other addresses.

## 保护 Dapr 到应用程序的通信

The Dapr sidecar runs close to the application through `localhost`, and is recommended to run under the same network boundary as the app. 尽管当今许多云原生系统将 pod 级别（例如在 Kubernetes 上）视为受信任的安全边界，但 Dapr 为应用程序提供了使用令牌的 API 级别身份验证。 This feature guarantees that, even on `localhost`:

- Only an authenticated application may call into Dapr
- An application can check that Dapr is calling it back

For more details on configuring API token security, read:

- [使用 API 令牌来验证从应用程序到 Dapr 的请求]({{< ref api-token.md >}})。
- [使用 API 令牌来验证从 Dapr 到应用程序的请求。]({{< ref app-api-token.md >}})

## 保护 Dapr 到控制平面的通信

In addition to automatic mTLS between Dapr sidecars, Dapr offers mandatory mTLS between:

- The Dapr sidecar
- The Dapr control plane system services, namely:
  - The Sentry service (a Certificate Authority)
  - The Placement service (actor placement)
  - The Kubernetes Operator service

When mTLS is enabled, Sentry writes the root and issuer certificates to a Kubernetes secret scoped to the namespace where the control plane is installed. 在自托管模式下，Sentry 将证书写入可配置的文件系统路径下。

In Kubernetes, when Dapr system services start, they automatically mount and use the secret containing the root and issuer certs to secure the gRPC server used by the Dapr sidecar. 在自托管模式下，每个系统服务都可以装载文件系统路径以获取证书。

当 Dapr sidecar 初始化时，它使用挂载的叶证书和颁发者私钥对系统 pod 进行身份验证。 这些作为环境变量挂载在 sidecar 容器上。

### Kubernetes 中系统服务的 mTLS

The diagram below shows secure communication between the Dapr sidecar and the Dapr Sentry (Certificate Authority), Placement (actor placement), and the Kubernetes Operator system services.

<img src="/images/security-mTLS-dapr-system-services.png" width=1000>
</br>

# 操作安全性

Dapr is designed for operators to manage mTLS certificates and enforce OAuth policies.

## mTLS 证书部署和轮换

While operators and developers can bring their own certificates into Dapr, Dapr automatically creates and persists self-signed root and issuer certificates. Read [Setup & configure mTLS certificates]({{< ref mtls.md >}}) for more details.

## 使用 OAuth 的中间件端点授权

With Dapr OAuth 2.0 middleware, you can enable OAuth authorization on Dapr endpoints for your APIs. Read [Configure endpoint authorization with OAuth]({{< ref oauth.md >}}) for details. Dapr has other middleware components that you can use for OpenID Connect and OPA Policies. For more details, [read about supported middleware]({{< ref supported-middleware.md >}}).

## 网络安全

You can adopt common network security technologies, such as network security groups (NSGs), demilitarized zones (DMZs), and firewalls, to provide layers of protection over your networked resources. For example, unless configured to talk to an external binding target, Dapr sidecars don’t open connections to the internet and most binding implementations only use outbound connections. 您可以设计防火墙规则，只允许通过指定的端口进行出站连接。

# 安全策略

Dapr has an extensive set of security policies you can apply to your applications. You can scope what they are able to do, either through a policy setting in the sidecar configuration, or with the component specification.

## API 访问策略

In certain scenarios, such as with zero trust networks or when exposing the Dapr sidecar to external traffic through a frontend, it’s recommended to only enable the Dapr sidecar APIs currently used by the app. This reduces the attack surface and keeps the Dapr APIs scoped to the actual needs of the application. 您可以通过在配置中设置 API 允许列表来控制应用程序可以访问哪些 API，如下图所示。

<img src="/images/security-dapr-API-scoping.png" width=1000>

Read [How-To: Selectively enable Dapr APIs on the Dapr sidecar]({{< ref api-allowlist.md >}}) for more details.

## 秘密范围访问策略

To limit the Dapr application's access to secrets, you can define secret scopes. Add a secret scope policy to the application configuration with restrictive permissions. Read [How To: Use secret scoping]({{< ref secret-scope.md >}}) for more details.

## 组件应用程序范围访问策略和秘密使用

Dapr 组件是受限于命名空间的。 这意味着 Dapr sidecar 的实例只能访问部署到同一命名空间的组件。 Read [How-To: Scope components to one or more applications using namespaces]({{< ref component-scopes.md >}}) for more details.

Dapr 允许您指定哪些应用程序可以使用特定组件并拒绝其他组件，从而为组件提供应用程序级别的范围。 Read [restricting application access to components with scopes]({{< ref "component-scopes.md#application-access-to-components-with-scopes" >}}) for more details.

Dapr 组件可以使用 Dapr 的内置秘密管理功能来管理秘密。 Read the [secret store overview]({{< ref secrets-overview.md >}}) and [How-To: Reference secrets in components]({{< ref component-secrets.md >}}) for more details.

## 绑定安全性

具有绑定目标的身份验证由绑定的配置文件配置。 通常，应配置所需的最低访问权限。 例如，如果仅从绑定目标读取，则应配置绑定以使用具有只读访问权限的帐户。

# 状态安全性

## State store encryption at rest

默认情况下，Dapr 不会转换应用程序的状态数据。 This means:

- Dapr doesn't attempt to encrypt/decrypt state data
- Your application can adopt encryption/decryption methods of your choice, where the state data remains opaque to Dapr.

Dapr 组件可以使用配置的身份验证方法与底层状态存储进行身份验证。 许多状态存储实现都使用官方客户端库，这些客户端库通常使用安全通信通道和服务器通讯。

However, application state often needs to get encrypted at rest to provide stronger security in enterprise workloads or regulated environments. Dapr provides automatic client-side state encryption based on AES256. 阅读 [操作方法：加密应用程序状态]({{< ref howto-encrypt-state.md >}}) 了解更多详细信息。

## Dapr Runtime state

The Dapr runtime does not store any data at rest, meaning that Dapr runtime has no dependency on any state stores for its operation and can be considered stateless.

# Using security capabilities in an example application

The diagram below shows a number of security capabilities placed in an example application hosted on Kubernetes. In the example, the Dapr control plane, the Redis state store, and each of the services have been deployed to their own namespaces. When deploying on Kubernetes, you can use regular Kubernetes RBAC to control access to management activities.

在应用程序中，请求由入口反向代理接收，它旁边运行着一个 Dapr sidecar。 From the reverse proxy, Dapr uses service invocation to call onto Service A, which then publishes a message to Service B. Service B retrieves a secret in order to read and save state to a Redis state store.

<img src="/images/security-overview-capabilities-example.png" width=1000>

让我们回顾一下每个安全功能，并描述它们如何保护此应用程序。

1. API Token authentication ensures the reverse-proxy knows it is communicating with the correct Dapr sidecar instance. This prevents forwarding messages to anything except this Dapr sidecar.
2. Service invocation mTLS is used for authentication between the reverse proxy and Service A. A service access policy configured on Service A restricts it to only receive calls on a specific endpoint from the reverse proxy and no other services.
3. Service B uses a pub/sub topic security policy to indicate it can only receive messages published from Service A.
4. Redis 组件定义使用组件范围安全策略来说明只允许服务 B 调用它。
5. Service B restricts the Dapr sidecar to only use the pub/sub, state management, and secrets APIs. All other API calls (for example, service invocation) would fail.
6. A secrets security policy set in configuration restricts which secrets Service B can access. In this case, Service B can only read the secret needed to connect to the Redis state store component, and no others.
7. Service B is deployed to namespace "B", which further isolates it from other services. Even if the service invocation API was enabled on it, it could not be called accidentally by being in the same namespace as Service A. Service B must explicitly set the Redis Host namespace in its component YAML file to call onto the "Redis" namespace, otherwise this call also fails.
8. Redis 状态存储中的数据是静态加密的，只能使用正确配置的 Dapr Redis 状态存储组件读取。

# 威胁模型

Threat modeling is a process by which:

- Potential threats, like structural vulnerabilities or the absence of appropriate safeguards, can be identified and enumerated.
- Mitigation can be prioritized.

Dapr 威胁模型如下：

<img src="/images/security-threat-model.png" alt="Dapr 威胁模型" width=1000>

## 安全审核

### 2021 年 2 月

In February 2021, Dapr went through a 2nd security audit targeting its 1.0 release by Cure53.

测试的重点是：

- 自上次审计以来的 Dapr 运行时间代码基础评估
- 访问控制列表
- 密钥管理
- 渗透测试
- 流量欺骗

You can find the full report [here](/docs/Dapr-february-2021-security-audit-report.pdf).

测试期间修复了两个问题，一个是关键问题，一个是高优先级问题。

As of February 16, 2021, Dapr has 0 criticals, 0 highs, 0 mediums, 2 lows, 2 infos.

### 2020年6月

2020 年 6 月，Dapr 接受了 CNCF 核定的网络安全公司 Cure53 的安全审计。

测试的重点是：

- Dapr 运行时代码库评估
- Dapr 组件代码基础评估
- Dapr CLI 代码基础评估
- 权限升级
- 流量欺骗
- 密钥管理
- RBAC
- 验证基本假设：mTLS、作用域、API 身份验证
- 编排强化 ( Kubernetes)
- DoS 攻击
- 渗透测试

完整的报告可以 [在这里](/docs/Dapr-july-2020-security-audit-report.pdf) 找到。

## 报告安全问题

访问 [此页面]({{< ref support-security-issues.md >}}) 向 Dapr 维护者报告安全问题。

## 相关链接

[操作安全性]({{< ref "security.md" >}})